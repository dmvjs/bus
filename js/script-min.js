var WMATA={ll:[],currentLines:[],getPosition:function(){"use strict";function t(t){WMATA.ll=[t.coords.latitude,t.coords.longitude],console.log("attempt"),void 0===WMATA.stops?WMATA.getStops():WMATA.getStopPrediction()}window.navigator.geolocation?window.navigator.geolocation.getCurrentPosition(t,function(){alert("This device requires geolocation. Please enable and refresh.")}):window.alert("This device does not allow geolocation, which is required for this application.")},getStops:function(){WMATA.pureAjax("http://api.wmata.com/Bus.svc/json/JStops?lat="+WMATA.ll[0]+"&lon="+WMATA.ll[1]+"&radius=500&api_key="+WMATA.key+"&callback=WMATA.gotStops")},gotStops:function(t){var e=window.document.getElementById("stop");WMATA.stops=t,WMATA.closestStop=WMATA.stops.Stops[WMATA.stopHaversine(WMATA.ll[0],WMATA.ll[1])],window.document.title="WMATA "+WMATA.closestStop.Name+" Stop",e.innerText=WMATA.closestStop.Name,e.textContent=WMATA.closestStop.Name,WMATA.getStopPrediction()},getStopPrediction:function(){WMATA.pureAjax("http://api.wmata.com/NextBusService.svc/json/JPredictions?StopID="+WMATA.closestStop.StopID+"&api_key="+WMATA.key+"&callback=WMATA.gotStopPrediction")},gotStopPrediction:function(t){WMATA.stopPredictions=t,WMATA.displayResults(),WMATA.getBusPositions()},getBusPositions:function(){WMATA.pureAjax("http://api.wmata.com/Bus.svc/json/JBusPositions?routeId="+WMATA.stops.Stops[0].Routes[0]+"&includingVariations=true&api_key="+WMATA.key+"&callback=WMATA.gotBusPositions")},gotBusPositions:function(t){WMATA.busPositions=t,WMATA.displayBusPositions()},stopHaversine:function(t,e){"use strict";var o,i,n,s,a,c,d,A,r,l,u=[-1,2e4],p=6371;for(l=0;WMATA.stops.Stops.length>l;l+=1)o=t,n=WMATA.stops.Stops[l].Lat,i=e,s=WMATA.stops.Stops[l].Lon,a=(n-o)*Math.PI/180,c=(s-i)*Math.PI/180,o=o*Math.PI/180,n=n*Math.PI/180,d=Math.sin(a/2)*Math.sin(a/2)+Math.sin(c/2)*Math.sin(c/2)*Math.cos(o)*Math.cos(n),A=2*Math.atan2(Math.sqrt(d),Math.sqrt(1-d)),r=p*A,u[1]>r&&(u=[l,r]);return u[0]},computeTime:function(t){var e=new Date,o=e.getHours(),i=e.getMinutes(),n=t.split(":"),s=parseInt(n[0],10),a=parseInt(n[1],10),c="",d="";return i>a&&(c+=i-a+" minute"+(1===parseInt(i-a,10)?"":"s")),o>s&&(""!==c&&(d=", "),c+=d+o-s+" hour"+(1===parseInt(o-s,10)?"":"s")),""===c?c="just now":c+=" ago",c},displayResults:function(){"use strict";var t,e,o,i,n=window.document.getElementById("schedule"),s=["RouteID","DirectionText","Minutes"],a=window.document.createElement("table"),c=window.document.createElement("thead"),d=window.document.createElement("tbody"),A='<tr><th class="th1">RTE</th><th class="th2">DIRECTION</th><th class="th3">MIN</th></tr>';for(null!==window.document.getElementById("table1")&&n.removeChild(window.document.getElementById("table1")),c.id="thead1",c.innerHTML=A,a.id="table1",a.appendChild(c),console.log(WMATA.stopPredictions),o=0;WMATA.stopPredictions.Predictions.length>o;o+=1){for(t=window.document.createElement("tr"),t.className="row",i=0;s.length>i;i+=1)e=window.document.createElement("td"),0===i?e.appendChild(window.document.createTextNode(WMATA.stopPredictions.Predictions[o].RouteID)):e.appendChild(window.document.createTextNode(WMATA.stopPredictions.Predictions[o][s[i]])),e.className="cell"+(i+1),t.appendChild(e);d.appendChild(t)}a.appendChild(d),n.appendChild(a),window.setTimeout(function(){WMATA.getPosition()},3e4),void 0===WMATA.rainbow&&(/mobile/i.test(navigator.userAgent)&&setTimeout(function(){window.scrollTo(0,1)},200),WMATA.rainbow="unicorn")},displayBusPositions:function(){var t,e,o,i,n,s=window.document.getElementById("position");for(o=0;WMATA.busPositions.BusPositions.length>o;o+=1)WMATA.busPositions.BusPositions[o].VehicleID===WMATA.stopPredictions.Predictions[0].VehicleID&&(t=WMATA.busPositions.BusPositions[o]);i=1===parseInt(Math.abs(t.Deviation).toFixed(0),10)?" minute ":" minutes ",delayNotice=(parseFloat(t.Deviation)>0?i+"ahead of ":i+"behind ")+"schedule.",n=parseInt(Math.abs(t.Deviation).toFixed(0),10),delay=0===n?"It is currently on time.":"It is running about ",void 0===t?s.innerHTML="The next bus is not reporting its location at this time.":e=WMATA.stopHaversine(t.Lat,t.Lon),void 0!==t&&(s.innerHTML="The next bus was near "+WMATA.stops.Stops[e].Name+" as of "+WMATA.computeTime(t.DateTime.split("T")[1])+". "+delay+(n>0?n:"")+delayNotice)},pureAjax:function(t){"use strict";var e=window.document.createElement("script");e.src=t,e.async=!0,window.document.body.appendChild(e)},key:"e8apbxn8jucqbk7bvv2wn2qm"};(function(){"use strict";WMATA.getPosition()})();